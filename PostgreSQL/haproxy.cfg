global
    daemon
    log stdout local0
    maxconn 4096
    user haproxy
    group haproxy

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Statistics interface
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# PostgreSQL Write (Primary)
frontend postgres_write
    bind *:5430
    mode tcp
    default_backend postgres_primary

backend postgres_primary
    mode tcp
    option tcp-check
    tcp-check connect
    tcp-check send-binary 00000020 # packet length
    tcp-check send-binary 00030000 # protocol version
    tcp-check send-binary 7573657200 # "user\0"
    tcp-check send-binary 706f737467726573 # "postgres"
    tcp-check send-binary 00 # null terminator
    tcp-check send-binary 6461746162617365 # "database"
    tcp-check send-binary 00 # null terminator
    tcp-check send-binary 64657664620000 # "devdb\0\0"
    tcp-check expect binary 52 # Auth OK
    server primary postgres-primary:5432 check inter 5000 rise 2 fall 3

# PostgreSQL Read (Replicas)
frontend postgres_read
    bind *:5431
    mode tcp
    default_backend postgres_replicas

backend postgres_replicas
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check send-binary 00000020
    tcp-check send-binary 00030000
    tcp-check send-binary 7573657200
    tcp-check send-binary 706f737467726573
    tcp-check send-binary 00
    tcp-check send-binary 6461746162617365
    tcp-check send-binary 00
    tcp-check send-binary 64657664620000
    tcp-check expect binary 52
    server replica1 postgres-replica-1:5432 check inter 5000 rise 2 fall 3
    server replica2 postgres-replica-2:5432 check inter 5000 rise 2 fall 3
